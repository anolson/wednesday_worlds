#!/bin/sh
set -e

rm -f ./tmp/pids/server.pid

echo "Installing gems."
bundle check || (bundle install && bundle clean)

if [ -z "$LITESTREAM_REPLICATION" ]; then
  # Remove symlink if it exists
  [ -L "$APP_DATA_PATH" ] && rm -f $APP_DATA_PATH

  echo "Starting Rails Server."
  bundle exec rails server -b 0.0.0.0 -p $PORT
else
  if  [ ! -f $LITESTREAM_DATA_PATH ]; then
    echo "Restoring litestream data."
    litestream restore -v -if-replica-exists -o $LITESTREAM_DATA_PATH $LITESTREAM_REPLICA_URL
  fi

  ln -nfs $LITESTREAM_DATA_PATH $APP_DATA_PATH

  echo "Starting Rails Server (with litestream replication)."
  litestream replicate -exec "bundle exec rails server -b 0.0.0.0 -p $PORT" $LITESTREAM_DATA_PATH $LITESTREAM_REPLICA_URL
fi
